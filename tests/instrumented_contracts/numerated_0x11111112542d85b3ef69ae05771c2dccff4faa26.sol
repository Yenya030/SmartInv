1 /**
2  *Submitted for verification at Etherscan.io on 2021-03-11
3 */
4 
5 /*
6                                                            ,▄▓▓██▌   ,╓▄▄▓▓▓▓▓▓▓▓▄▄▄,,                          
7                                                         ,▓██▓███▓▄▓███▓╬╬╬╬╬╬╬╬╬╬╬╬╬▓███▓▄,                     
8                                                   ▄█   ▓██╬╣███████╬▓▀╬╬▓▓▓████████████▓█████▄,                 
9                                                  ▓██▌ ▓██╬╣██████╬▓▌  ██████████████████████▌╙╙▀ⁿ
10                                                 ▐████████╬▓████▓▓█╨ ▄ ╟█████████▓▓╬╬╬╬╬▓▓█████▓▄
11                                   └▀▓▓▄╓        ╟█▓╣█████▓██████▀ ╓█▌ ███████▓▓▓▓▓╬╬╬╬╬╬╬╬╬╬╬╬▓██▓▄
12                                      └▀████▓▄╥  ▐██╬╬██████████╙ Æ▀─ ▓███▀╚╠╬╩▀▀███████▓▓╬╬╬╬╬╬╬╬╬██▄
13                                         └▀██▓▀▀█████▓╬▓██████▀     ▄█████▒╠"      └╙▓██████▓╬╬╬╬╬╬╬╬██▄
14                                            └▀██▄,└╙▀▀████▌└╙    ^"▀╙╙╙"╙██      @▄    ╙▀███████╬╬╬╬╬╬╬██µ
15                                               └▀██▓▄, ██▌       ╒       ╙█▓     ]▓█▓╔    ▀███████▓╬╬╬╬╬▓█▌
16                                                   ▀█████       ▓         ╟█▌    ]╠██▓░▒╓   ▀████████╬╬╬╬╣█▌
17                                                   ▐████      ╓█▀█▌      ,██▌    ╚Å███▓▒▒╠╓  ╙█████████╬╬╬╣█▌
18                                                   └████     ▓█░░▓█      ▀▀▀    φ▒╫████▒▒▒▒╠╓  █████████▓╬╬▓█µ
19                                                    ╘███µ ▌▄█▓▄▓▀`     ,▀    ,╔╠░▓██████▌╠▒▒▒φ  ██████████╬╬██
20                                                    ▐████µ╙▓▀`     ,▀╙,╔╔φφφ╠░▄▓███████▌░▓╙▒▒▒╠ └██╬███████╬▓█⌐
21                                                    ╫██ ▓▌         ▌φ▒▒░▓██████████████▌▒░▓╚▒▒▒╠ ▓██╬▓██████╣█▌
22                                                    ██▌           ▌╔▒▒▄████████████████▒▒▒░▌╠▒▒▒≥▐██▓╬╬███████▌
23                                                    ██▌      ,╓φ╠▓«▒▒▓████▀  ▀█████████▌▒▒▒╟░▒▒▒▒▐███╬╬╣████▓█▌
24                                                   ▐██      ╠▒▄▓▓███▓████└     ▀████████▌▒▒░▌╚▒▒▒▐███▓╬╬████ ╙▌
25                                                   ███  )  ╠▒░░░▒░╬████▀        └████████░▒▒░╬∩▒▒▓████╬╬╣███
26                                                  ▓██    ╠╠▒▒▐█▀▀▌`░╫██           ███████▒▒▒▒░▒▒½█████╬╬╣███
27                                                 ███ ,█▄ ╠▒▒▒╫▌,▄▀,▒╫██           ╟██████▒▒▒░╣⌠▒▓█████╬╬╣██▌
28                                                ╘██µ ██` ╠▒▒░██╬φ╠▄▓██`            ██████░░▌φ╠░▓█████▓╬╬▓██
29                                                 ╟██  .φ╠▒░▄█▀░░▄██▀└              █████▌▒╣φ▒░▓██████╬╬╣██
30                                                  ▀██▄▄▄╓▄███████▀                ▐█████░▓φ▒▄███████▓╬╣██
31                                                    ╙▀▀▀██▀└                      ████▓▄▀φ▄▓████████╬▓█▀
32                                                                                 ▓███╬╩╔╣██████████▓██└
33                                                                               ╓████▀▄▓████████▀████▀
34                                                                             ,▓███████████████─]██╙
35                                                                          ,▄▓██████████████▀└  ╙
36                                                                     ,╓▄▓███████████████▀╙
37                                                              `"▀▀▀████████▀▀▀▀`▄███▀▀└
38                                                                               └└
39                                 
40                     
41 
42                     11\   11\                     11\             11\   11\            11\                                       11\       
43                   1111 |  \__|                    11 |            111\  11 |           11 |                                      11 |      
44                   \_11 |  11\ 1111111\   1111111\ 1111111\        1111\ 11 | 111111\ 111111\   11\  11\  11\  111111\   111111\  11 |  11\ 
45                     11 |  11 |11  __11\ 11  _____|11  __11\       11 11\11 |11  __11\\_11  _|  11 | 11 | 11 |11  __11\ 11  __11\ 11 | 11  |
46                     11 |  11 |11 |  11 |11 /      11 |  11 |      11 \1111 |11111111 | 11 |    11 | 11 | 11 |11 /  11 |11 |  \__|111111  / 
47                     11 |  11 |11 |  11 |11 |      11 |  11 |      11 |\111 |11   ____| 11 |11\ 11 | 11 | 11 |11 |  11 |11 |      11  _11<  
48                   111111\ 11 |11 |  11 |\1111111\ 11 |  11 |      11 | \11 |\1111111\  \1111  |\11111\1111  |\111111  |11 |      11 | \11\ 
49                   \______|\__|\__|  \__| \_______|\__|  \__|      \__|  \__| \_______|  \____/  \_____\____/  \______/ \__|      \__|  \__|
50                                                                                                                                            
51                                                                                                                                            
52                                                                                                                                            
53                                111111\                                                               11\     11\                           
54                               11  __11\                                                              11 |    \__|                          
55                               11 /  11 | 111111\   111111\   111111\   111111\   111111\   111111\ 111111\   11\  111111\  1111111\        
56                               11111111 |11  __11\ 11  __11\ 11  __11\ 11  __11\ 11  __11\  \____11\\_11  _|  11 |11  __11\ 11  __11\       
57                               11  __11 |11 /  11 |11 /  11 |11 |  \__|11111111 |11 /  11 | 1111111 | 11 |    11 |11 /  11 |11 |  11 |      
58                               11 |  11 |11 |  11 |11 |  11 |11 |      11   ____|11 |  11 |11  __11 | 11 |11\ 11 |11 |  11 |11 |  11 |      
59                               11 |  11 |\1111111 |\1111111 |11 |      \1111111\ \1111111 |\1111111 | \1111  |11 |\111111  |11 |  11 |      
60                               \__|  \__| \____11 | \____11 |\__|       \_______| \____11 | \_______|  \____/ \__| \______/ \__|  \__|      
61                                         11\   11 |11\   11 |                    11\   11 |                                                 
62                                         \111111  |\111111  |                    \111111  |                                                 
63                                          \______/  \______/                      \______/                                                  
64                                                 1111111\                        11\                                                        
65                                                 11  __11\                       11 |                                                       
66                                                 11 |  11 | 111111\  11\   11\ 111111\    111111\   111111\                                 
67                                                 1111111  |11  __11\ 11 |  11 |\_11  _|  11  __11\ 11  __11\                                
68                                                 11  __11< 11 /  11 |11 |  11 |  11 |    11111111 |11 |  \__|                               
69                                                 11 |  11 |11 |  11 |11 |  11 |  11 |11\ 11   ____|11 |                                     
70                                                 11 |  11 |\111111  |\111111  |  \1111  |\1111111\ 11 |                                     
71                                                 \__|  \__| \______/  \______/    \____/  \_______|\__|                                     
72 */
73 
74 // File @openzeppelin/contracts/utils/Context.sol@v3.4.1
75 
76 // SPDX-License-Identifier: MIT
77 
78 pragma solidity >=0.6.0 <0.8.0;
79 
80 /*
81  * @dev Provides information about the current execution context, including the
82  * sender of the transaction and its data. While these are generally available
83  * via msg.sender and msg.data, they should not be accessed in such a direct
84  * manner, since when dealing with GSN meta-transactions the account sending and
85  * paying for execution may not be the actual sender (as far as an application
86  * is concerned).
87  *
88  * This contract is only required for intermediate, library-like contracts.
89  */
90 abstract contract Context {
91     function _msgSender() internal view virtual returns (address payable) {
92         return msg.sender;
93     }
94 
95     function _msgData() internal view virtual returns (bytes memory) {
96         this; // silence state mutability warning without generating bytecode - see https://github.com/ethereum/solidity/issues/2691
97         return msg.data;
98     }
99 }
100 
101 
102 // File @openzeppelin/contracts/access/Ownable.sol@v3.4.1
103 
104 
105 
106 pragma solidity >=0.6.0 <0.8.0;
107 
108 /**
109  * @dev Contract module which provides a basic access control mechanism, where
110  * there is an account (an owner) that can be granted exclusive access to
111  * specific functions.
112  *
113  * By default, the owner account will be the one that deploys the contract. This
114  * can later be changed with {transferOwnership}.
115  *
116  * This module is used through inheritance. It will make available the modifier
117  * `onlyOwner`, which can be applied to your functions to restrict their use to
118  * the owner.
119  */
120 abstract contract Ownable is Context {
121     address private _owner;
122 
123     event OwnershipTransferred(address indexed previousOwner, address indexed newOwner);
124 
125     /**
126      * @dev Initializes the contract setting the deployer as the initial owner.
127      */
128     constructor () internal {
129         address msgSender = _msgSender();
130         _owner = msgSender;
131         emit OwnershipTransferred(address(0), msgSender);
132     }
133 
134     /**
135      * @dev Returns the address of the current owner.
136      */
137     function owner() public view virtual returns (address) {
138         return _owner;
139     }
140 
141     /**
142      * @dev Throws if called by any account other than the owner.
143      */
144     modifier onlyOwner() {
145         require(owner() == _msgSender(), "Ownable: caller is not the owner");
146         _;
147     }
148 
149     /**
150      * @dev Leaves the contract without owner. It will not be possible to call
151      * `onlyOwner` functions anymore. Can only be called by the current owner.
152      *
153      * NOTE: Renouncing ownership will leave the contract without an owner,
154      * thereby removing any functionality that is only available to the owner.
155      */
156     function renounceOwnership() public virtual onlyOwner {
157         emit OwnershipTransferred(_owner, address(0));
158         _owner = address(0);
159     }
160 
161     /**
162      * @dev Transfers ownership of the contract to a new account (`newOwner`).
163      * Can only be called by the current owner.
164      */
165     function transferOwnership(address newOwner) public virtual onlyOwner {
166         require(newOwner != address(0), "Ownable: new owner is the zero address");
167         emit OwnershipTransferred(_owner, newOwner);
168         _owner = newOwner;
169     }
170 }
171 
172 
173 // File @openzeppelin/contracts/token/ERC20/IERC20.sol@v3.4.1
174 
175 
176 
177 pragma solidity >=0.6.0 <0.8.0;
178 
179 /**
180  * @dev Interface of the ERC20 standard as defined in the EIP.
181  */
182 interface IERC20 {
183     /**
184      * @dev Returns the amount of tokens in existence.
185      */
186     function totalSupply() external view returns (uint256);
187 
188     /**
189      * @dev Returns the amount of tokens owned by `account`.
190      */
191     function balanceOf(address account) external view returns (uint256);
192 
193     /**
194      * @dev Moves `amount` tokens from the caller's account to `recipient`.
195      *
196      * Returns a boolean value indicating whether the operation succeeded.
197      *
198      * Emits a {Transfer} event.
199      */
200     function transfer(address recipient, uint256 amount) external returns (bool);
201 
202     /**
203      * @dev Returns the remaining number of tokens that `spender` will be
204      * allowed to spend on behalf of `owner` through {transferFrom}. This is
205      * zero by default.
206      *
207      * This value changes when {approve} or {transferFrom} are called.
208      */
209     function allowance(address owner, address spender) external view returns (uint256);
210 
211     /**
212      * @dev Sets `amount` as the allowance of `spender` over the caller's tokens.
213      *
214      * Returns a boolean value indicating whether the operation succeeded.
215      *
216      * IMPORTANT: Beware that changing an allowance with this method brings the risk
217      * that someone may use both the old and the new allowance by unfortunate
218      * transaction ordering. One possible solution to mitigate this race
219      * condition is to first reduce the spender's allowance to 0 and set the
220      * desired value afterwards:
221      * https://github.com/ethereum/EIPs/issues/20#issuecomment-263524729
222      *
223      * Emits an {Approval} event.
224      */
225     function approve(address spender, uint256 amount) external returns (bool);
226 
227     /**
228      * @dev Moves `amount` tokens from `sender` to `recipient` using the
229      * allowance mechanism. `amount` is then deducted from the caller's
230      * allowance.
231      *
232      * Returns a boolean value indicating whether the operation succeeded.
233      *
234      * Emits a {Transfer} event.
235      */
236     function transferFrom(address sender, address recipient, uint256 amount) external returns (bool);
237 
238     /**
239      * @dev Emitted when `value` tokens are moved from one account (`from`) to
240      * another (`to`).
241      *
242      * Note that `value` may be zero.
243      */
244     event Transfer(address indexed from, address indexed to, uint256 value);
245 
246     /**
247      * @dev Emitted when the allowance of a `spender` for an `owner` is set by
248      * a call to {approve}. `value` is the new allowance.
249      */
250     event Approval(address indexed owner, address indexed spender, uint256 value);
251 }
252 
253 
254 // File @openzeppelin/contracts/math/SafeMath.sol@v3.4.1
255 
256 
257 
258 pragma solidity >=0.6.0 <0.8.0;
259 
260 /**
261  * @dev Wrappers over Solidity's arithmetic operations with added overflow
262  * checks.
263  *
264  * Arithmetic operations in Solidity wrap on overflow. This can easily result
265  * in bugs, because programmers usually assume that an overflow raises an
266  * error, which is the standard behavior in high level programming languages.
267  * `SafeMath` restores this intuition by reverting the transaction when an
268  * operation overflows.
269  *
270  * Using this library instead of the unchecked operations eliminates an entire
271  * class of bugs, so it's recommended to use it always.
272  */
273 library SafeMath {
274     /**
275      * @dev Returns the addition of two unsigned integers, with an overflow flag.
276      *
277      * _Available since v3.4._
278      */
279     function tryAdd(uint256 a, uint256 b) internal pure returns (bool, uint256) {
280         uint256 c = a + b;
281         if (c < a) return (false, 0);
282         return (true, c);
283     }
284 
285     /**
286      * @dev Returns the substraction of two unsigned integers, with an overflow flag.
287      *
288      * _Available since v3.4._
289      */
290     function trySub(uint256 a, uint256 b) internal pure returns (bool, uint256) {
291         if (b > a) return (false, 0);
292         return (true, a - b);
293     }
294 
295     /**
296      * @dev Returns the multiplication of two unsigned integers, with an overflow flag.
297      *
298      * _Available since v3.4._
299      */
300     function tryMul(uint256 a, uint256 b) internal pure returns (bool, uint256) {
301         // Gas optimization: this is cheaper than requiring 'a' not being zero, but the
302         // benefit is lost if 'b' is also tested.
303         // See: https://github.com/OpenZeppelin/openzeppelin-contracts/pull/522
304         if (a == 0) return (true, 0);
305         uint256 c = a * b;
306         if (c / a != b) return (false, 0);
307         return (true, c);
308     }
309 
310     /**
311      * @dev Returns the division of two unsigned integers, with a division by zero flag.
312      *
313      * _Available since v3.4._
314      */
315     function tryDiv(uint256 a, uint256 b) internal pure returns (bool, uint256) {
316         if (b == 0) return (false, 0);
317         return (true, a / b);
318     }
319 
320     /**
321      * @dev Returns the remainder of dividing two unsigned integers, with a division by zero flag.
322      *
323      * _Available since v3.4._
324      */
325     function tryMod(uint256 a, uint256 b) internal pure returns (bool, uint256) {
326         if (b == 0) return (false, 0);
327         return (true, a % b);
328     }
329 
330     /**
331      * @dev Returns the addition of two unsigned integers, reverting on
332      * overflow.
333      *
334      * Counterpart to Solidity's `+` operator.
335      *
336      * Requirements:
337      *
338      * - Addition cannot overflow.
339      */
340     function add(uint256 a, uint256 b) internal pure returns (uint256) {
341         uint256 c = a + b;
342         require(c >= a, "SafeMath: addition overflow");
343         return c;
344     }
345 
346     /**
347      * @dev Returns the subtraction of two unsigned integers, reverting on
348      * overflow (when the result is negative).
349      *
350      * Counterpart to Solidity's `-` operator.
351      *
352      * Requirements:
353      *
354      * - Subtraction cannot overflow.
355      */
356     function sub(uint256 a, uint256 b) internal pure returns (uint256) {
357         require(b <= a, "SafeMath: subtraction overflow");
358         return a - b;
359     }
360 
361     /**
362      * @dev Returns the multiplication of two unsigned integers, reverting on
363      * overflow.
364      *
365      * Counterpart to Solidity's `*` operator.
366      *
367      * Requirements:
368      *
369      * - Multiplication cannot overflow.
370      */
371     function mul(uint256 a, uint256 b) internal pure returns (uint256) {
372         if (a == 0) return 0;
373         uint256 c = a * b;
374         require(c / a == b, "SafeMath: multiplication overflow");
375         return c;
376     }
377 
378     /**
379      * @dev Returns the integer division of two unsigned integers, reverting on
380      * division by zero. The result is rounded towards zero.
381      *
382      * Counterpart to Solidity's `/` operator. Note: this function uses a
383      * `revert` opcode (which leaves remaining gas untouched) while Solidity
384      * uses an invalid opcode to revert (consuming all remaining gas).
385      *
386      * Requirements:
387      *
388      * - The divisor cannot be zero.
389      */
390     function div(uint256 a, uint256 b) internal pure returns (uint256) {
391         require(b > 0, "SafeMath: division by zero");
392         return a / b;
393     }
394 
395     /**
396      * @dev Returns the remainder of dividing two unsigned integers. (unsigned integer modulo),
397      * reverting when dividing by zero.
398      *
399      * Counterpart to Solidity's `%` operator. This function uses a `revert`
400      * opcode (which leaves remaining gas untouched) while Solidity uses an
401      * invalid opcode to revert (consuming all remaining gas).
402      *
403      * Requirements:
404      *
405      * - The divisor cannot be zero.
406      */
407     function mod(uint256 a, uint256 b) internal pure returns (uint256) {
408         require(b > 0, "SafeMath: modulo by zero");
409         return a % b;
410     }
411 
412     /**
413      * @dev Returns the subtraction of two unsigned integers, reverting with custom message on
414      * overflow (when the result is negative).
415      *
416      * CAUTION: This function is deprecated because it requires allocating memory for the error
417      * message unnecessarily. For custom revert reasons use {trySub}.
418      *
419      * Counterpart to Solidity's `-` operator.
420      *
421      * Requirements:
422      *
423      * - Subtraction cannot overflow.
424      */
425     function sub(uint256 a, uint256 b, string memory errorMessage) internal pure returns (uint256) {
426         require(b <= a, errorMessage);
427         return a - b;
428     }
429 
430     /**
431      * @dev Returns the integer division of two unsigned integers, reverting with custom message on
432      * division by zero. The result is rounded towards zero.
433      *
434      * CAUTION: This function is deprecated because it requires allocating memory for the error
435      * message unnecessarily. For custom revert reasons use {tryDiv}.
436      *
437      * Counterpart to Solidity's `/` operator. Note: this function uses a
438      * `revert` opcode (which leaves remaining gas untouched) while Solidity
439      * uses an invalid opcode to revert (consuming all remaining gas).
440      *
441      * Requirements:
442      *
443      * - The divisor cannot be zero.
444      */
445     function div(uint256 a, uint256 b, string memory errorMessage) internal pure returns (uint256) {
446         require(b > 0, errorMessage);
447         return a / b;
448     }
449 
450     /**
451      * @dev Returns the remainder of dividing two unsigned integers. (unsigned integer modulo),
452      * reverting with custom message when dividing by zero.
453      *
454      * CAUTION: This function is deprecated because it requires allocating memory for the error
455      * message unnecessarily. For custom revert reasons use {tryMod}.
456      *
457      * Counterpart to Solidity's `%` operator. This function uses a `revert`
458      * opcode (which leaves remaining gas untouched) while Solidity uses an
459      * invalid opcode to revert (consuming all remaining gas).
460      *
461      * Requirements:
462      *
463      * - The divisor cannot be zero.
464      */
465     function mod(uint256 a, uint256 b, string memory errorMessage) internal pure returns (uint256) {
466         require(b > 0, errorMessage);
467         return a % b;
468     }
469 }
470 
471 
472 // File @openzeppelin/contracts/utils/Address.sol@v3.4.1
473 
474 
475 
476 pragma solidity >=0.6.2 <0.8.0;
477 
478 /**
479  * @dev Collection of functions related to the address type
480  */
481 library Address {
482     /**
483      * @dev Returns true if `account` is a contract.
484      *
485      * [IMPORTANT]
486      * ====
487      * It is unsafe to assume that an address for which this function returns
488      * false is an externally-owned account (EOA) and not a contract.
489      *
490      * Among others, `isContract` will return false for the following
491      * types of addresses:
492      *
493      *  - an externally-owned account
494      *  - a contract in construction
495      *  - an address where a contract will be created
496      *  - an address where a contract lived, but was destroyed
497      * ====
498      */
499     function isContract(address account) internal view returns (bool) {
500         // This method relies on extcodesize, which returns 0 for contracts in
501         // construction, since the code is only stored at the end of the
502         // constructor execution.
503 
504         uint256 size;
505         // solhint-disable-next-line no-inline-assembly
506         assembly { size := extcodesize(account) }
507         return size > 0;
508     }
509 
510     /**
511      * @dev Replacement for Solidity's `transfer`: sends `amount` wei to
512      * `recipient`, forwarding all available gas and reverting on errors.
513      *
514      * https://eips.ethereum.org/EIPS/eip-1884[EIP1884] increases the gas cost
515      * of certain opcodes, possibly making contracts go over the 2300 gas limit
516      * imposed by `transfer`, making them unable to receive funds via
517      * `transfer`. {sendValue} removes this limitation.
518      *
519      * https://diligence.consensys.net/posts/2019/09/stop-using-soliditys-transfer-now/[Learn more].
520      *
521      * IMPORTANT: because control is transferred to `recipient`, care must be
522      * taken to not create reentrancy vulnerabilities. Consider using
523      * {ReentrancyGuard} or the
524      * https://solidity.readthedocs.io/en/v0.5.11/security-considerations.html#use-the-checks-effects-interactions-pattern[checks-effects-interactions pattern].
525      */
526     function sendValue(address payable recipient, uint256 amount) internal {
527         require(address(this).balance >= amount, "Address: insufficient balance");
528 
529         // solhint-disable-next-line avoid-low-level-calls, avoid-call-value
530         (bool success, ) = recipient.call{ value: amount }("");
531         require(success, "Address: unable to send value, recipient may have reverted");
532     }
533 
534     /**
535      * @dev Performs a Solidity function call using a low level `call`. A
536      * plain`call` is an unsafe replacement for a function call: use this
537      * function instead.
538      *
539      * If `target` reverts with a revert reason, it is bubbled up by this
540      * function (like regular Solidity function calls).
541      *
542      * Returns the raw returned data. To convert to the expected return value,
543      * use https://solidity.readthedocs.io/en/latest/units-and-global-variables.html?highlight=abi.decode#abi-encoding-and-decoding-functions[`abi.decode`].
544      *
545      * Requirements:
546      *
547      * - `target` must be a contract.
548      * - calling `target` with `data` must not revert.
549      *
550      * _Available since v3.1._
551      */
552     function functionCall(address target, bytes memory data) internal returns (bytes memory) {
553       return functionCall(target, data, "Address: low-level call failed");
554     }
555 
556     /**
557      * @dev Same as {xref-Address-functionCall-address-bytes-}[`functionCall`], but with
558      * `errorMessage` as a fallback revert reason when `target` reverts.
559      *
560      * _Available since v3.1._
561      */
562     function functionCall(address target, bytes memory data, string memory errorMessage) internal returns (bytes memory) {
563         return functionCallWithValue(target, data, 0, errorMessage);
564     }
565 
566     /**
567      * @dev Same as {xref-Address-functionCall-address-bytes-}[`functionCall`],
568      * but also transferring `value` wei to `target`.
569      *
570      * Requirements:
571      *
572      * - the calling contract must have an ETH balance of at least `value`.
573      * - the called Solidity function must be `payable`.
574      *
575      * _Available since v3.1._
576      */
577     function functionCallWithValue(address target, bytes memory data, uint256 value) internal returns (bytes memory) {
578         return functionCallWithValue(target, data, value, "Address: low-level call with value failed");
579     }
580 
581     /**
582      * @dev Same as {xref-Address-functionCallWithValue-address-bytes-uint256-}[`functionCallWithValue`], but
583      * with `errorMessage` as a fallback revert reason when `target` reverts.
584      *
585      * _Available since v3.1._
586      */
587     function functionCallWithValue(address target, bytes memory data, uint256 value, string memory errorMessage) internal returns (bytes memory) {
588         require(address(this).balance >= value, "Address: insufficient balance for call");
589         require(isContract(target), "Address: call to non-contract");
590 
591         // solhint-disable-next-line avoid-low-level-calls
592         (bool success, bytes memory returndata) = target.call{ value: value }(data);
593         return _verifyCallResult(success, returndata, errorMessage);
594     }
595 
596     /**
597      * @dev Same as {xref-Address-functionCall-address-bytes-}[`functionCall`],
598      * but performing a static call.
599      *
600      * _Available since v3.3._
601      */
602     function functionStaticCall(address target, bytes memory data) internal view returns (bytes memory) {
603         return functionStaticCall(target, data, "Address: low-level static call failed");
604     }
605 
606     /**
607      * @dev Same as {xref-Address-functionCall-address-bytes-string-}[`functionCall`],
608      * but performing a static call.
609      *
610      * _Available since v3.3._
611      */
612     function functionStaticCall(address target, bytes memory data, string memory errorMessage) internal view returns (bytes memory) {
613         require(isContract(target), "Address: static call to non-contract");
614 
615         // solhint-disable-next-line avoid-low-level-calls
616         (bool success, bytes memory returndata) = target.staticcall(data);
617         return _verifyCallResult(success, returndata, errorMessage);
618     }
619 
620     /**
621      * @dev Same as {xref-Address-functionCall-address-bytes-}[`functionCall`],
622      * but performing a delegate call.
623      *
624      * _Available since v3.4._
625      */
626     function functionDelegateCall(address target, bytes memory data) internal returns (bytes memory) {
627         return functionDelegateCall(target, data, "Address: low-level delegate call failed");
628     }
629 
630     /**
631      * @dev Same as {xref-Address-functionCall-address-bytes-string-}[`functionCall`],
632      * but performing a delegate call.
633      *
634      * _Available since v3.4._
635      */
636     function functionDelegateCall(address target, bytes memory data, string memory errorMessage) internal returns (bytes memory) {
637         require(isContract(target), "Address: delegate call to non-contract");
638 
639         // solhint-disable-next-line avoid-low-level-calls
640         (bool success, bytes memory returndata) = target.delegatecall(data);
641         return _verifyCallResult(success, returndata, errorMessage);
642     }
643 
644     function _verifyCallResult(bool success, bytes memory returndata, string memory errorMessage) private pure returns(bytes memory) {
645         if (success) {
646             return returndata;
647         } else {
648             // Look for revert reason and bubble it up if present
649             if (returndata.length > 0) {
650                 // The easiest way to bubble the revert reason is using memory via assembly
651 
652                 // solhint-disable-next-line no-inline-assembly
653                 assembly {
654                     let returndata_size := mload(returndata)
655                     revert(add(32, returndata), returndata_size)
656                 }
657             } else {
658                 revert(errorMessage);
659             }
660         }
661     }
662 }
663 
664 
665 // File @openzeppelin/contracts/token/ERC20/SafeERC20.sol@v3.4.1
666 
667 
668 
669 pragma solidity >=0.6.0 <0.8.0;
670 
671 
672 
673 /**
674  * @title SafeERC20
675  * @dev Wrappers around ERC20 operations that throw on failure (when the token
676  * contract returns false). Tokens that return no value (and instead revert or
677  * throw on failure) are also supported, non-reverting calls are assumed to be
678  * successful.
679  * To use this library you can add a `using SafeERC20 for IERC20;` statement to your contract,
680  * which allows you to call the safe operations as `token.safeTransfer(...)`, etc.
681  */
682 library SafeERC20 {
683     using SafeMath for uint256;
684     using Address for address;
685 
686     function safeTransfer(IERC20 token, address to, uint256 value) internal {
687         _callOptionalReturn(token, abi.encodeWithSelector(token.transfer.selector, to, value));
688     }
689 
690     function safeTransferFrom(IERC20 token, address from, address to, uint256 value) internal {
691         _callOptionalReturn(token, abi.encodeWithSelector(token.transferFrom.selector, from, to, value));
692     }
693 
694     /**
695      * @dev Deprecated. This function has issues similar to the ones found in
696      * {IERC20-approve}, and its usage is discouraged.
697      *
698      * Whenever possible, use {safeIncreaseAllowance} and
699      * {safeDecreaseAllowance} instead.
700      */
701     function safeApprove(IERC20 token, address spender, uint256 value) internal {
702         // safeApprove should only be called when setting an initial allowance,
703         // or when resetting it to zero. To increase and decrease it, use
704         // 'safeIncreaseAllowance' and 'safeDecreaseAllowance'
705         // solhint-disable-next-line max-line-length
706         require((value == 0) || (token.allowance(address(this), spender) == 0),
707             "SafeERC20: approve from non-zero to non-zero allowance"
708         );
709         _callOptionalReturn(token, abi.encodeWithSelector(token.approve.selector, spender, value));
710     }
711 
712     function safeIncreaseAllowance(IERC20 token, address spender, uint256 value) internal {
713         uint256 newAllowance = token.allowance(address(this), spender).add(value);
714         _callOptionalReturn(token, abi.encodeWithSelector(token.approve.selector, spender, newAllowance));
715     }
716 
717     function safeDecreaseAllowance(IERC20 token, address spender, uint256 value) internal {
718         uint256 newAllowance = token.allowance(address(this), spender).sub(value, "SafeERC20: decreased allowance below zero");
719         _callOptionalReturn(token, abi.encodeWithSelector(token.approve.selector, spender, newAllowance));
720     }
721 
722     /**
723      * @dev Imitates a Solidity high-level call (i.e. a regular function call to a contract), relaxing the requirement
724      * on the return value: the return value is optional (but if data is returned, it must not be false).
725      * @param token The token targeted by the call.
726      * @param data The call data (encoded using abi.encode or one of its variants).
727      */
728     function _callOptionalReturn(IERC20 token, bytes memory data) private {
729         // We need to perform a low level call here, to bypass Solidity's return data size checking mechanism, since
730         // we're implementing it ourselves. We use {Address.functionCall} to perform this call, which verifies that
731         // the target address contains contract code and also asserts for success in the low-level call.
732 
733         bytes memory returndata = address(token).functionCall(data, "SafeERC20: low-level call failed");
734         if (returndata.length > 0) { // Return data is optional
735             // solhint-disable-next-line max-line-length
736             require(abi.decode(returndata, (bool)), "SafeERC20: ERC20 operation did not succeed");
737         }
738     }
739 }
740 
741 
742 // File contracts/helpers/UniERC20.sol
743 
744 
745 
746 pragma solidity ^0.6.12;
747 
748 
749 library UniERC20 {
750     using SafeMath for uint256;
751 
752     IERC20 private constant _ETH_ADDRESS = IERC20(0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE);
753     IERC20 private constant _ZERO_ADDRESS = IERC20(0);
754 
755     function isETH(IERC20 token) internal pure returns (bool) {
756         return (token == _ZERO_ADDRESS || token == _ETH_ADDRESS);
757     }
758 
759     function uniBalanceOf(IERC20 token, address account) internal view returns (uint256) {
760         if (isETH(token)) {
761             return account.balance;
762         } else {
763             return token.balanceOf(account);
764         }
765     }
766 
767     function uniTransfer(IERC20 token, address payable to, uint256 amount) internal {
768         if (amount > 0) {
769             if (isETH(token)) {
770                 to.transfer(amount);
771             } else {
772                 _callOptionalReturn(token, abi.encodeWithSelector(token.transfer.selector, to, amount));
773             }
774         }
775     }
776 
777     function uniApprove(IERC20 token, address to, uint256 amount) internal {
778         require(!isETH(token), "Approve called on ETH");
779 
780         // solhint-disable-next-line avoid-low-level-calls
781         (bool success, bytes memory returndata) = address(token).call(abi.encodeWithSelector(token.approve.selector, to, amount));
782 
783         if (!success || (returndata.length > 0 && !abi.decode(returndata, (bool)))) {
784             _callOptionalReturn(token, abi.encodeWithSelector(token.approve.selector, to, 0));
785             _callOptionalReturn(token, abi.encodeWithSelector(token.approve.selector, to, amount));
786         }
787     }
788 
789     function _callOptionalReturn(IERC20 token, bytes memory data) private {
790         // solhint-disable-next-line avoid-low-level-calls
791         (bool success, bytes memory returndata) = address(token).call(data);
792         require(success, "low-level call failed");
793 
794         if (returndata.length > 0) { // Return data is optional
795             require(abi.decode(returndata, (bool)), "ERC20 operation did not succeed");
796         }
797     }
798 }
799 
800 
801 // File contracts/interfaces/IChi.sol
802 
803 
804 
805 pragma solidity ^0.6.12;
806 
807 interface IChi is IERC20 {
808     function mint(uint256 value) external;
809     function free(uint256 value) external returns (uint256 freed);
810     function freeFromUpTo(address from, uint256 value) external returns (uint256 freed);
811 }
812 
813 
814 // File contracts/interfaces/IGasDiscountExtension.sol
815 
816 
817 
818 pragma solidity ^0.6.12;
819 
820 interface IGasDiscountExtension {
821     function calculateGas(uint256 gasUsed, uint256 flags, uint256 calldataLength) external view returns (IChi, uint256);
822 }
823 
824 
825 // File contracts/interfaces/IAggregationExecutor.sol
826 
827 
828 
829 pragma solidity ^0.6.12;
830 
831 interface IAggregationExecutor is IGasDiscountExtension {
832     function callBytes(bytes calldata data) external payable;  // 0xd9c45357
833 }
834 
835 
836 // File contracts/helpers/RevertReasonParser.sol
837 
838 
839 
840 pragma solidity ^0.6.12;
841 
842 
843 library RevertReasonParser {
844     function parse(bytes memory data, string memory prefix) internal pure returns (string memory) {
845         // https://solidity.readthedocs.io/en/latest/control-structures.html#revert
846         // We assume that revert reason is abi-encoded as Error(string)
847 
848         // 68 = 4-byte selector 0x08c379a0 + 32 bytes offset + 32 bytes length
849         if (data.length >= 68 && data[0] == "\x08" && data[1] == "\xc3" && data[2] == "\x79" && data[3] == "\xa0") {
850             string memory reason;
851             // solhint-disable no-inline-assembly
852             assembly {
853                 // 68 = 32 bytes data length + 4-byte selector + 32 bytes offset
854                 reason := add(data, 68)
855             }
856             /*
857                 revert reason is padded up to 32 bytes with ABI encoder: Error(string)
858                 also sometimes there is extra 32 bytes of zeros padded in the end:
859                 https://github.com/ethereum/solidity/issues/10170
860                 because of that we can't check for equality and instead check
861                 that string length + extra 68 bytes is less than overall data length
862             */
863             require(data.length >= 68 + bytes(reason).length, "Invalid revert reason");
864             return string(abi.encodePacked(prefix, "Error(", reason, ")"));
865         }
866         // 36 = 4-byte selector 0x4e487b71 + 32 bytes integer
867         else if (data.length == 36 && data[0] == "\x4e" && data[1] == "\x48" && data[2] == "\x7b" && data[3] == "\x71") {
868             uint256 code;
869             // solhint-disable no-inline-assembly
870             assembly {
871                 // 36 = 32 bytes data length + 4-byte selector
872                 code := mload(add(data, 36))
873             }
874             return string(abi.encodePacked(prefix, "Panic(", _toHex(code), ")"));
875         }
876 
877         return string(abi.encodePacked(prefix, "Unknown(", _toHex(data), ")"));
878     }
879 
880     function _toHex(uint256 value) private pure returns(string memory) {
881         return _toHex(abi.encodePacked(value));
882     }
883 
884     function _toHex(bytes memory data) private pure returns(string memory) {
885         bytes16 alphabet = 0x30313233343536373839616263646566;
886         bytes memory str = new bytes(2 + data.length * 2);
887         str[0] = "0";
888         str[1] = "x";
889         for (uint256 i = 0; i < data.length; i++) {
890             str[2 * i + 2] = alphabet[uint8(data[i] >> 4)];
891             str[2 * i + 3] = alphabet[uint8(data[i] & 0x0f)];
892         }
893         return string(str);
894     }
895 }
896 
897 
898 // File contracts/interfaces/IERC20Permit.sol
899 
900 
901 
902 pragma solidity ^0.6.12;
903 
904 
905 interface IERC20Permit {
906     function permit(address owner, address spender, uint256 amount, uint256 deadline, uint8 v, bytes32 r, bytes32 s) external;
907 }
908 
909 
910 // File contracts/helpers/Permitable.sol
911 
912 
913 
914 pragma solidity ^0.6.12;
915 
916 
917 
918 contract Permitable {
919     event Error(
920         string reason
921     );
922 
923     function _permit(IERC20 token, uint256 amount, bytes calldata permit) internal {
924         if (permit.length == 32 * 7) {
925             // solhint-disable-next-line avoid-low-level-calls
926             (bool success, bytes memory result) = address(token).call(abi.encodePacked(IERC20Permit.permit.selector, permit));
927             if (!success) {
928                 string memory reason = RevertReasonParser.parse(result, "Permit call failed: ");
929                 if (token.allowance(msg.sender, address(this)) < amount) {
930                     revert(reason);
931                 } else {
932                     emit Error(reason);
933                 }
934             }
935         }
936     }
937 }
938 
939 
940 // File contracts/UnoswapRouter.sol
941 
942 
943 
944 pragma solidity ^0.6.12;
945 
946 contract UnoswapRouter is Permitable {
947     uint256 private constant _TRANSFER_FROM_CALL_SELECTOR_32 = 0x23b872dd00000000000000000000000000000000000000000000000000000000;
948     uint256 private constant _WETH_DEPOSIT_CALL_SELECTOR_32 = 0xd0e30db000000000000000000000000000000000000000000000000000000000;
949     uint256 private constant _WETH_WITHDRAW_CALL_SELECTOR_32 = 0x2e1a7d4d00000000000000000000000000000000000000000000000000000000;
950     uint256 private constant _ERC20_TRANSFER_CALL_SELECTOR_32 = 0xa9059cbb00000000000000000000000000000000000000000000000000000000;
951     uint256 private constant _ADDRESS_MASK =   0x000000000000000000000000ffffffffffffffffffffffffffffffffffffffff;
952     uint256 private constant _REVERSE_MASK =   0x8000000000000000000000000000000000000000000000000000000000000000;
953     uint256 private constant _WETH_MASK =      0x4000000000000000000000000000000000000000000000000000000000000000;
954     uint256 private constant _NUMERATOR_MASK = 0x0000000000000000ffffffff0000000000000000000000000000000000000000;
955     uint256 private constant _WETH = 0x000000000000000000000000C02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2;
956     uint256 private constant _UNISWAP_PAIR_RESERVES_CALL_SELECTOR_32 = 0x0902f1ac00000000000000000000000000000000000000000000000000000000;
957     uint256 private constant _UNISWAP_PAIR_SWAP_CALL_SELECTOR_32 = 0x022c0d9f00000000000000000000000000000000000000000000000000000000;
958     uint256 private constant _DENOMINATOR = 1000000000;
959     uint256 private constant _NUMERATOR_OFFSET = 160;
960 
961     receive() external payable {
962         // solhint-disable-next-line avoid-tx-origin
963         require(msg.sender != tx.origin, "ETH deposit rejected");
964     }
965 
966     function unoswapWithPermit(
967         IERC20 srcToken,
968         uint256 amount,
969         uint256 minReturn,
970         bytes32[] calldata pools,
971         bytes calldata permit
972     ) external payable returns(uint256 returnAmount) {
973         _permit(srcToken, amount, permit);
974         return unoswap(srcToken, amount, minReturn, pools);
975     }
976 
977     function unoswap(
978         IERC20 srcToken,
979         uint256 amount,
980         uint256 minReturn,
981         bytes32[] calldata /* pools */
982     ) public payable returns(uint256 returnAmount) {
983         assembly {  // solhint-disable-line no-inline-assembly
984             function reRevert() {
985                 returndatacopy(0, 0, returndatasize())
986                 revert(0, returndatasize())
987             }
988 
989             function revertWithReason(m, len) {
990                 mstore(0, 0x08c379a000000000000000000000000000000000000000000000000000000000)
991                 mstore(0x20, 0x0000002000000000000000000000000000000000000000000000000000000000)
992                 mstore(0x40, m)
993                 revert(0, len)
994             }
995 
996             function swap(emptyPtr, swapAmount, pair, reversed, numerator, dst) -> ret {
997                 mstore(emptyPtr, _UNISWAP_PAIR_RESERVES_CALL_SELECTOR_32)
998                 if iszero(staticcall(gas(), pair, emptyPtr, 0x4, emptyPtr, 0x40)) {
999                     reRevert()
1000                 }
1001 
1002                 let reserve0 := mload(emptyPtr)
1003                 let reserve1 := mload(add(emptyPtr, 0x20))
1004                 if reversed {
1005                     let tmp := reserve0
1006                     reserve0 := reserve1
1007                     reserve1 := tmp
1008                 }
1009                 ret := mul(swapAmount, numerator)
1010                 ret := div(mul(ret, reserve1), add(ret, mul(reserve0, _DENOMINATOR)))
1011 
1012                 mstore(emptyPtr, _UNISWAP_PAIR_SWAP_CALL_SELECTOR_32)
1013                 switch reversed
1014                 case 0 {
1015                     mstore(add(emptyPtr, 0x04), 0)
1016                     mstore(add(emptyPtr, 0x24), ret)
1017                 }
1018                 default {
1019                     mstore(add(emptyPtr, 0x04), ret)
1020                     mstore(add(emptyPtr, 0x24), 0)
1021                 }
1022                 mstore(add(emptyPtr, 0x44), dst)
1023                 mstore(add(emptyPtr, 0x64), 0x80)
1024                 mstore(add(emptyPtr, 0x84), 0)
1025                 if iszero(call(gas(), pair, 0, emptyPtr, 0xa4, 0, 0)) {
1026                     reRevert()
1027                 }
1028             }
1029 
1030             let emptyPtr := mload(0x40)
1031             mstore(0x40, add(emptyPtr, 0xc0))
1032 
1033             let poolsOffset := add(calldataload(0x64), 0x4)
1034             let poolsEndOffset := calldataload(poolsOffset)
1035             poolsOffset := add(poolsOffset, 0x20)
1036             poolsEndOffset := add(poolsOffset, mul(0x20, poolsEndOffset))
1037             let rawPair := calldataload(poolsOffset)
1038             switch srcToken
1039             case 0 {
1040                 if iszero(eq(amount, callvalue())) {
1041                     revertWithReason(0x00000011696e76616c6964206d73672e76616c75650000000000000000000000, 0x55)  // "invalid msg.value"
1042                 }
1043 
1044                 mstore(emptyPtr, _WETH_DEPOSIT_CALL_SELECTOR_32)
1045                 if iszero(call(gas(), _WETH, amount, emptyPtr, 0x4, 0, 0)) {
1046                     reRevert()
1047                 }
1048 
1049                 mstore(emptyPtr, _ERC20_TRANSFER_CALL_SELECTOR_32)
1050                 mstore(add(emptyPtr, 0x4), and(rawPair, _ADDRESS_MASK))
1051                 mstore(add(emptyPtr, 0x24), amount)
1052                 if iszero(call(gas(), _WETH, 0, emptyPtr, 0x44, 0, 0)) {
1053                     reRevert()
1054                 }
1055             }
1056             default {
1057                 if callvalue() {
1058                     revertWithReason(0x00000011696e76616c6964206d73672e76616c75650000000000000000000000, 0x55)  // "invalid msg.value"
1059                 }
1060 
1061                 mstore(emptyPtr, _TRANSFER_FROM_CALL_SELECTOR_32)
1062                 mstore(add(emptyPtr, 0x4), caller())
1063                 mstore(add(emptyPtr, 0x24), and(rawPair, _ADDRESS_MASK))
1064                 mstore(add(emptyPtr, 0x44), amount)
1065                 if iszero(call(gas(), srcToken, 0, emptyPtr, 0x64, 0, 0)) {
1066                     reRevert()
1067                 }
1068             }
1069 
1070             returnAmount := amount
1071 
1072             for {let i := add(poolsOffset, 0x20)} lt(i, poolsEndOffset) {i := add(i, 0x20)} {
1073                 let nextRawPair := calldataload(i)
1074 
1075                 returnAmount := swap(
1076                     emptyPtr,
1077                     returnAmount,
1078                     and(rawPair, _ADDRESS_MASK),
1079                     and(rawPair, _REVERSE_MASK),
1080                     shr(_NUMERATOR_OFFSET, and(rawPair, _NUMERATOR_MASK)),
1081                     and(nextRawPair, _ADDRESS_MASK)
1082                 )
1083 
1084                 rawPair := nextRawPair
1085             }
1086 
1087             switch and(rawPair, _WETH_MASK)
1088             case 0 {
1089                 returnAmount := swap(
1090                     emptyPtr,
1091                     returnAmount,
1092                     and(rawPair, _ADDRESS_MASK),
1093                     and(rawPair, _REVERSE_MASK),
1094                     shr(_NUMERATOR_OFFSET, and(rawPair, _NUMERATOR_MASK)),
1095                     caller()
1096                 )
1097             }
1098             default {
1099                 returnAmount := swap(
1100                     emptyPtr,
1101                     returnAmount,
1102                     and(rawPair, _ADDRESS_MASK),
1103                     and(rawPair, _REVERSE_MASK),
1104                     shr(_NUMERATOR_OFFSET, and(rawPair, _NUMERATOR_MASK)),
1105                     address()
1106                 )
1107 
1108                 mstore(emptyPtr, _WETH_WITHDRAW_CALL_SELECTOR_32)
1109                 mstore(add(emptyPtr, 0x04), returnAmount)
1110                 if iszero(call(gas(), _WETH, 0, emptyPtr, 0x24, 0, 0)) {
1111                     reRevert()
1112                 }
1113 
1114                 if iszero(call(gas(), caller(), returnAmount, 0, 0, 0, 0)) {
1115                     reRevert()
1116                 }
1117             }
1118 
1119             if lt(returnAmount, minReturn) {
1120                 revertWithReason(0x000000164d696e2072657475726e206e6f742072656163686564000000000000, 0x5a)  // "Min return not reached"
1121             }
1122         }
1123     }
1124 }
1125 
1126 
1127 // File contracts/AggregationRouterV3.sol
1128 
1129 
1130 
1131 pragma solidity ^0.6.12;
1132 pragma experimental ABIEncoderV2;
1133 
1134 
1135 
1136 
1137 
1138 
1139 contract AggregationRouterV3 is Ownable, UnoswapRouter {
1140     using SafeMath for uint256;
1141     using SafeERC20 for IERC20;
1142     using UniERC20 for IERC20;
1143 
1144     uint256 private constant _PARTIAL_FILL = 0x01;
1145     uint256 private constant _REQUIRES_EXTRA_ETH = 0x02;
1146     uint256 private constant _SHOULD_CLAIM = 0x04;
1147     uint256 private constant _BURN_FROM_MSG_SENDER = 0x08;
1148     uint256 private constant _BURN_FROM_TX_ORIGIN = 0x10;
1149 
1150     struct SwapDescription {
1151         IERC20 srcToken;
1152         IERC20 dstToken;
1153         address srcReceiver;
1154         address dstReceiver;
1155         uint256 amount;
1156         uint256 minReturnAmount;
1157         uint256 flags;
1158         bytes permit;
1159     }
1160 
1161     event Swapped(
1162         address sender,
1163         IERC20 srcToken,
1164         IERC20 dstToken,
1165         address dstReceiver,
1166         uint256 spentAmount,
1167         uint256 returnAmount
1168     );
1169 
1170     function discountedSwap(
1171         IAggregationExecutor caller,
1172         SwapDescription calldata desc,
1173         bytes calldata data
1174     )
1175         external
1176         payable
1177         returns (uint256 returnAmount, uint256 gasLeft, uint256 chiSpent)
1178     {
1179         uint256 initialGas = gasleft();
1180 
1181         address chiSource = address(0);
1182         if (desc.flags & _BURN_FROM_MSG_SENDER != 0) {
1183             chiSource = msg.sender;
1184         } else if (desc.flags & _BURN_FROM_TX_ORIGIN != 0) {
1185             chiSource = tx.origin; // solhint-disable-line avoid-tx-origin
1186         } else {
1187             revert("Incorrect CHI burn flags");
1188         }
1189 
1190         // solhint-disable-next-line avoid-low-level-calls
1191         (bool success, bytes memory returnData) = address(this).delegatecall(abi.encodeWithSelector(this.swap.selector, caller, desc, data));
1192         if (success) {
1193             (returnAmount,) = abi.decode(returnData, (uint256, uint256));
1194         } else {
1195             if (msg.value > 0) {
1196                 msg.sender.transfer(msg.value);
1197             }
1198             emit Error(RevertReasonParser.parse(returnData, "Swap failed: "));
1199         }
1200 
1201         (IChi chi, uint256 amount) = caller.calculateGas(initialGas.sub(gasleft()), desc.flags, msg.data.length);
1202         if (amount > 0) {
1203             chiSpent = chi.freeFromUpTo(chiSource, amount);
1204         }
1205         gasLeft = gasleft();
1206     }
1207 
1208     function swap(
1209         IAggregationExecutor caller,
1210         SwapDescription calldata desc,
1211         bytes calldata data
1212     )
1213         external
1214         payable
1215         returns (uint256 returnAmount, uint256 gasLeft)
1216     {
1217         require(desc.minReturnAmount > 0, "Min return should not be 0");
1218         require(data.length > 0, "data should be not zero");
1219 
1220         uint256 flags = desc.flags;
1221         IERC20 srcToken = desc.srcToken;
1222         IERC20 dstToken = desc.dstToken;
1223 
1224         if (flags & _REQUIRES_EXTRA_ETH != 0) {
1225             require(msg.value > (srcToken.isETH() ? desc.amount : 0), "Invalid msg.value");
1226         } else {
1227             require(msg.value == (srcToken.isETH() ? desc.amount : 0), "Invalid msg.value");
1228         }
1229 
1230         if (flags & _SHOULD_CLAIM != 0) {
1231             require(!srcToken.isETH(), "Claim token is ETH");
1232             _permit(srcToken, desc.amount, desc.permit);
1233             srcToken.safeTransferFrom(msg.sender, desc.srcReceiver, desc.amount);
1234         }
1235 
1236         address dstReceiver = (desc.dstReceiver == address(0)) ? msg.sender : desc.dstReceiver;
1237         uint256 initialSrcBalance = (flags & _PARTIAL_FILL != 0) ? srcToken.uniBalanceOf(msg.sender) : 0;
1238         uint256 initialDstBalance = dstToken.uniBalanceOf(dstReceiver);
1239 
1240         {
1241             // solhint-disable-next-line avoid-low-level-calls
1242             (bool success, bytes memory result) = address(caller).call{value: msg.value}(abi.encodePacked(caller.callBytes.selector, data));
1243             if (!success) {
1244                 revert(RevertReasonParser.parse(result, "callBytes failed: "));
1245             }
1246         }
1247 
1248         uint256 spentAmount = desc.amount;
1249         returnAmount = dstToken.uniBalanceOf(dstReceiver).sub(initialDstBalance);
1250 
1251         if (flags & _PARTIAL_FILL != 0) {
1252             spentAmount = initialSrcBalance.add(desc.amount).sub(srcToken.uniBalanceOf(msg.sender));
1253             require(returnAmount.mul(desc.amount) >= desc.minReturnAmount.mul(spentAmount), "Return amount is not enough");
1254         } else {
1255             require(returnAmount >= desc.minReturnAmount, "Return amount is not enough");
1256         }
1257 
1258         emit Swapped(
1259             msg.sender,
1260             srcToken,
1261             dstToken,
1262             dstReceiver,
1263             spentAmount,
1264             returnAmount
1265         );
1266 
1267         gasLeft = gasleft();
1268     }
1269 
1270     function rescueFunds(IERC20 token, uint256 amount) external onlyOwner {
1271         token.uniTransfer(msg.sender, amount);
1272     }
1273 
1274     function destroy() external onlyOwner {
1275         selfdestruct(msg.sender);
1276     }
1277 }